<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI 翻譯（中 → 韓 / 英）</title>
<link rel="stylesheet" href="styles.css" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<link rel="apple-touch-icon" href="icons/icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js");
    });
  }
</script>

</head>
<body>

<header>
  <div class="wrap">
    <h1>AI 翻譯（中 → 韓 / 英）</h1>
    <div class="nav">
      <a href="index.html">發音練習</a>
      <a href="travel.html">旅遊會話</a>
      <a class="active" href="translate.html">AI 翻譯</a>
      <a href="favorites.html">★ 收藏</a>
    </div>
    <div class="controls">
      <label>播放速度
        <select id="rate" class="select">
          <option value="0.5">×0.5</option>
          <option value="0.75" selected>×0.75</option>
          <option value="1.0">×1.0</option>
        </select>
      </label>
      <label class="control"><input type="checkbox" id="cartoonEn" />英文卡通模式</label>
      <label>英文聲音
        <select id="voiceEn" class="select"><option>載入中…</option></select>
      </label>
    </div>
    <div class="warn">使用免費公共翻譯 API（MyMemory；失敗嘗試 LibreTranslate）。若遇到流量或 CORS 限制，請稍後再試。</div>
  </div>
</header>

<main class="wrap">
  <div class="legend">輸入中文</div>
  <div class="input">
    <textarea id="cn" placeholder="例：這個有別的顏色嗎？"></textarea>
    <button class="control" id="btnTrans">翻譯 → 韓/英</button>
  </div>

  <div class="result" id="res" style="display:none">
    <div class="row">
      <div class="title">🇰🇷 韓文</div>
      <div>
        <button class="control" id="speakKo">朗讀韓文</button>
        <span class="star" id="star" title="加入收藏">☆</span>
      </div>
    </div>
    <div class="krl" id="koText">—</div>
    <div class="eng" id="enText">—</div>
    <div class="zh" id="zhText">—</div>
    <div class="row">
      <small class="small">英文朗讀：</small>
      <button class="control" id="speakEn">Play EN</button>
    </div>
  </div>
</main>

<footer>收藏保存在瀏覽器 localStorage。</footer>

<script>
const EN_WHITELIST = [
  {name:"Daniel",   lang:"en-GB"},
  {name:"Moira",    lang:"en-IE"},
  {name:"Samantha", lang:"en-AU"},
  {name:"Tessa",    lang:"en-ZA"}
];
function pickWhitelistedEnglishVoices(){
  const all = speechSynthesis.getVoices();
  const ok = [];
  EN_WHITELIST.forEach(w=>{
    const v = all.find(x => x.name===w.name && (x.lang||"").toLowerCase().startsWith(w.lang.toLowerCase()));
    if(v) ok.push(v);
  });
  return ok;
}
function populateEnglishVoices(){
  const sel = document.getElementById('voiceEn');
  sel.innerHTML = "";
  const list = pickWhitelistedEnglishVoices();
  if(!list.length){ sel.innerHTML = "<option>未找到：Daniel / Moira / Samantha / Tessa</option>"; return; }
  list.forEach((v,i)=>{
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = v.name + " ("+v.lang+")";
    sel.appendChild(opt);
    if(i===0) sel.value = v.name;
  });
  const stored = localStorage.getItem('voiceEnName');
  if(stored && list.some(v=>v.name===stored)) sel.value = stored;
  sel.addEventListener('change',()=>localStorage.setItem('voiceEnName', sel.value));
}
function rate(){ return parseFloat(document.getElementById('rate').value||'0.75'); }
function speakKO(t){
  const u = new SpeechSynthesisUtterance(t);
  const ko = speechSynthesis.getVoices().find(v => /ko/i.test(v.lang||""));
  if(ko) u.voice = ko;
  u.lang='ko-KR'; u.rate = rate();
  speechSynthesis.speak(u);
}
function speakEN(t){
  const sel=document.getElementById('voiceEn');
  const voices=speechSynthesis.getVoices();
  const en = voices.find(v=>v.name===sel.value) || pickWhitelistedEnglishVoices()[0] || null;
  const u = new SpeechSynthesisUtterance(t);
  if(en) u.voice=en;
  u.lang = (en && en.lang) ? en.lang : 'en-US';
  u.rate = rate();
  if(document.getElementById('cartoonEn').checked) u.pitch = 1.6;
  speechSynthesis.speak(u);
}
window.speechSynthesis.onvoiceschanged = ()=>populateEnglishVoices();
populateEnglishVoices();

async function myMemory(q, from, to){
  const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(q)}&langpair=${from}|${to}`;
  const r = await fetch(url);
  const j = await r.json();
  return j?.responseData?.translatedText || "";
}
async function libre(q, from, to){
  const r = await fetch("https://libretranslate.de/translate", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({q, source:from, target:to})
  });
  const j = await r.json();
  return j?.translatedText || "";
}
async function translateAll(zh){
  let en="", ko="";
  try{ en = await myMemory(zh,"zh-TW","en"); }catch(e){}
  try{ ko = await myMemory(zh,"zh-TW","ko"); }catch(e){}
  if(!en){ try{ en = await libre(zh,"zh","en"); }catch(e){} }
  if(!ko){ try{ ko = await libre(zh,"zh","ko"); }catch(e){} }
  return {en, ko};
}

const btn = document.getElementById('btnTrans');
const cn = document.getElementById('cn');
const res = document.getElementById('res');
const zhText = document.getElementById('zhText');
const enText = document.getElementById('enText');
const koText = document.getElementById('koText');
const star = document.getElementById('star');
document.getElementById('speakKo').addEventListener('click',()=>speakKO(koText.textContent||""));
document.getElementById('speakEn').addEventListener('click',()=>speakEN(enText.textContent||""));

btn.addEventListener('click', async ()=>{
  const text = (cn.value||"").trim();
  if(!text) return;
  res.style.display = 'block';
  zhText.textContent = text;
  enText.textContent = "翻譯中…";
  koText.textContent = "번역 중…";
  try{
    const out = await translateAll(text);
    enText.textContent = out.en || "(英文翻譯失敗)";
    koText.textContent = out.ko || "(韓文翻譯失敗)";
  }catch(e){
    enText.textContent = "(英文翻譯錯誤)";
    koText.textContent = "(韓文翻譯錯誤)";
  }
});

function getFavs(){ try{ return JSON.parse(localStorage.getItem('favorites')||'[]'); }catch(e){ return []; } }
function setFavs(arr){ localStorage.setItem('favorites', JSON.stringify(arr)); }
function currentItem(){ return { zh: zhText.textContent, en: enText.textContent, ko: koText.textContent, ts: Date.now() }; }
function toggleStar(){
  const item = currentItem();
  if(!item.zh || !item.en || !item.ko) return;
  const list = getFavs();
  const exists = list.find(x => x.zh===item.zh && x.en===item.en && x.ko===item.ko);
  if(exists){ setFavs(list.filter(x => !(x.zh===item.zh && x.en===item.en && x.ko===item.ko))); star.textContent = "☆"; }
  else{ list.unshift(item); setFavs(list); star.textContent = "★"; }
}
star.addEventListener('click', toggleStar);
new MutationObserver(()=>{
  const item = currentItem();
  const exists = getFavs().find(x => x.zh===item.zh && x.en===item.en && x.ko===item.ko);
  star.textContent = exists ? "★" : "☆";
}).observe(koText,{childList:true});
</script>

</body>
</html>