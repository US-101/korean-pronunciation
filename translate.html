<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>實時翻譯</title><link rel="manifest" href="manifest.json"><link rel="stylesheet" href="styles.css"></head><body>
<header class='appbar'><div class='bar'><h1 class='title'>實 時 翻 譯</h1></div></header>

    <div class="appbar"><div class="row">
      <select id="speedSel" class="pill amber select">
        <option value="0.5">x0.5</option>
        <option value="0.75">x0.75</option>
        <option value="1">x1</option>
      </select>
      <span id="mickey" class="pill"><svg viewBox='0 0 24 24' aria-hidden='true'><circle cx='12' cy='12' r='6' stroke='currentColor' fill='none' stroke-width='2'/><circle cx='6' cy='6' r='3' stroke='currentColor' fill='none' stroke-width='2'/><circle cx='18' cy='6' r='3' stroke='currentColor' fill='none' stroke-width='2'/></svg></span>
      
        <select id="voiceSel" class="pill select" style="min-width:140px">
          <option>Daniel</option>
          <option>Moira</option>
          <option>Samantha</option>
          <option>Tessa</option>
        </select>
        
    </div></div>
    
<main class="wrap">
  <textarea id="src" placeholder="在此輸入要翻譯的內容..."></textarea>
  <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
    <button id="doTrans" class="pill teal">翻 譯</button>
  </div>
  <div class="list" id="results"></div>
</main>

    <nav class="tabbar"><div class="in">
      <a class='' href='index.html'><span class='ico'><svg viewBox='0 0 24 24' aria-hidden='true'><circle cx='12' cy='12' r='10' stroke='currentColor' fill='none' stroke-width='2'/></svg></span>發音練習</a>
      <a class='' href='travel.html'><span class='ico'><svg viewBox='0 0 24 24' aria-hidden='true'><rect x='4' y='4' width='16' height='16' stroke='currentColor' fill='none' stroke-width='2'/></svg></span>旅行會話</a>
      <a class='active' href='translate.html'><span class='ico'><svg viewBox='0 0 24 24' aria-hidden='true'><path d='M21 21l-4.3-4.3M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16z' stroke='currentColor' fill='none' stroke-width='2'/></svg></span>實時翻譯</a>
      <a class='' href='history.html'><span class='ico'><svg viewBox='0 0 24 24' aria-hidden='true'><circle cx='12' cy='12' r='9' stroke='currentColor' fill='none' stroke-width='2'/><path d='M12 7v5l3 3' stroke='currentColor' fill='none' stroke-width='2'/></svg></span>歷史紀錄</a>
    </div></nav>
    
<script>
let rate = parseFloat(localStorage.getItem('rate')||'0.75');
let cartoon = localStorage.getItem('cartoon')==='1';
const m = document.getElementById('mickey'); if(cartoon) m.classList.add('teal');
m.addEventListener('click',()=>{cartoon=!cartoon;localStorage.setItem('cartoon',cartoon?'1':'0');m.classList.toggle('teal',cartoon);});
document.getElementById('speedSel').addEventListener('change',()=>{rate=parseFloat(speedSel.value);localStorage.setItem('rate',rate);});
const voiceSel = document.getElementById('voiceSel');
function pickVoiceByName(name) {
  const vs=speechSynthesis.getVoices();
  const map={Daniel:/en-GB/i,Moira:/en-IE/i,Samantha:/en-AU/i,Tessa:/en-ZA/i};
  const re=map[name];
  return vs.find(v=>re.test(v.lang||'')|| (v.name&&v.name.includes(name)));
}
function speak(text, lang='ko-KR') {
  const u=new SpeechSynthesisUtterance(text); u.lang=lang; u.rate=rate;
  if(lang.startsWith('en')) u.pitch = cartoon?1.6:1.0;
  if(lang.startsWith('en')) { const v=pickVoiceByName(voiceSel.value); if(v) u.voice=v; }
  if(lang.startsWith('ko')) { const v=speechSynthesis.getVoices().find(v=>/ko/i.test(v.lang||'')); if(v) u.voice=v; }
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
// Favorites & history
const FOLDERS = ['旅行','購物','問路','其他'];
function getHistory(){return JSON.parse(localStorage.getItem('history')||'[]');}
function setHistory(arr){localStorage.setItem('history',JSON.stringify(arr.slice(0,10)));}
function addToHistory(item){const arr=getHistory();arr.unshift(item);setHistory(arr);}
function getFav(){return JSON.parse(localStorage.getItem('fav')||'{}');}
function addFav(folder,item){const fav=getFav();fav[folder]=fav[folder]||[];fav[folder].unshift(item);localStorage.setItem('fav',JSON.stringify(fav));}
// UI
const results=document.getElementById('results');
function renderResult(src, ko, en) {
  results.innerHTML='';
  const c=document.createElement('div'); c.className='card';
  c.innerHTML=`<div class='zh'>${src}</div>
    <div class='ko' style='margin-top:6px'>${ko}</div>
    <div class='en'>${en}</div>
    <div class='badges'>
      <span class='badge' data-say='${ko}' data-lang='ko'>韓</span>
      <span class='badge' data-say='${en}' data-lang='en'>英</span>
      <span class='star' title='收藏'>★</span>
    </div>`;
  results.appendChild(c);
  // star -> select folder
  c.querySelector('.star').addEventListener('click',()=>{
    const folder = prompt('收藏到哪個資料夾？（旅行/購物/問路/其他）','旅行');
    if(!folder) return;
    const f=FOLDERS.includes(folder)?folder:'其他';
    addFav(f,{src,ko,en,ts:Date.now()});
    alert('已收藏到：'+f);
  });
}
// TTS click handlers
document.addEventListener('click',e=>{
  const b=e.target.closest('.badge'); if(!b) return;
  const lang=b.getAttribute('data-lang'); const text=b.getAttribute('data-say');
  speak(text, lang==='en'?'en':'ko-KR');
});
// Translation (tries LibreTranslate, fallback to echo demo)
async function translateText(q) {
  // Try LibreTranslate (public demo). If CORS/network fails, fallback simple echo.
  const payload = {q, source:'zh', target:'ko', format:'text'};
  try {
    const r = await fetch('https://libretranslate.de/translate', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(r.ok) {
      const data = await r.json();
      const ko = data.translatedText || '';
      // Also translate to English for display
      const r2 = await fetch('https://libretranslate.de/translate', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({q, source:'zh', target:'en', format:'text'})
      });
      const d2 = r2.ok ? await r2.json() : {translatedText:''};
      return {ko:ko||q, en:d2.translatedText||q};
    }
  } catch(e) {}
  // Fallback: very naive "translation"
  return {ko:q, en:q};
}
document.getElementById('doTrans').addEventListener('click', async ()=>{
  const q = document.getElementById('src').value.trim();
  if(!q) return;
  const out = await translateText(q);
  renderResult(q, out.ko, out.en);
  addToHistory({src:q, ko:out.ko, en:out.en, ts:Date.now()});
});
</script>
</body></html>
