<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>實時翻譯</title>
<link rel="stylesheet" href="styles.css" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<link rel="apple-touch-icon" href="icons/icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<script>
  if ("serviceWorker" in navigator) { window.addEventListener("load", () => { navigator.serviceWorker.register("/sw.js"); }); }
</script>
</head>
<body>

<header class="appbar">
  <div class="wrap">
    <h1>實時翻譯</h1>
    <div class="badge">x0.75</div>
  </div>
</header>

<main class="wrap">
  <div class="controls">
    <label>英文聲音 <select id="voiceEn" class="select"></select></label>
    <label class="control">卡通模式 <span id="mickey" class="icon-mickey"></span></label>
  </div>

  <div class="legend">輸入中文</div>
  <div class="input">
    <textarea id="cn" placeholder="例：這個有別的顏色嗎？"></textarea>
    <button class="control" id="btnTrans">翻譯 → 韓/英</button>
  </div>

  <div class="bigcard" id="res" style="display:none">
    <div class="row">
      <div class="title">翻譯結果</div>
      <div><button class="control" id="speakKo">朗讀韓文</button> <span class="star" id="star" title="加入收藏">☆</span></div>
    </div>
    <div class="krl" id="koText">—</div>
    <div class="eng" id="enText">—</div>
    <div class="zh" id="zhText">—</div>
    <div class="row">
      <small class="small">英文朗讀：</small>
      <button class="control" id="speakEn">Play EN</button>
    </div>
  </div>
</main>
<nav class="tabbar"><div class="in">
<a class='' href='index.html'><svg width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='#9aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 10l9-7 9 7v7a2 2 0 0 1-2 2h-3m-8 0H6a2 2 0 0 1-2-2v-7'/></svg><span>發音練習</span></a>
<a class='' href='travel.html'><svg width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='#9aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M21 16v-5a2 2 0 0 0-2-2h-5l-3-3-3 3H3a2 2 0 0 0-2 2v5'/></svg><span>旅行會話</span></a>
<a class='active' href='translate.html'><svg width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='#9aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M4 5h7M7.5 5c0 6 5 9 9 9m0 0l-3-3m3 3l3-3'/></svg><span>實時翻譯</span></a>
<a class='' href='history.html'><svg width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='#9aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 8v5l3 3M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0'/></svg><span>歷史紀錄</span></a>
</div></nav>
<footer>收藏保存在瀏覽器 localStorage。最新 10 筆會寫入「歷史紀錄」。</footer>

<script>
const EN=["Daniel","Moira","Samantha","Tessa"];
function listEn(){ const all=speechSynthesis.getVoices(); const ok=[]; EN.forEach(n=>{ const v=all.find(x=>x.name===n); if(v) ok.push(v); }); return ok; }
function populate(){
  const sel=document.getElementById('voiceEn'); sel.innerHTML="";
  const list=listEn(); if(!list.length){ sel.innerHTML="<option>載入中…</option>"; return; }
  list.forEach((v,i)=>{ const o=document.createElement('option'); o.value=v.name; o.textContent=v.name; sel.appendChild(o); if(i===0) sel.value=v.name; });
  const saved=localStorage.getItem('voiceEnName'); if(saved && list.some(v=>v.name===saved)) sel.value=saved;
  sel.addEventListener('change',()=>localStorage.setItem('voiceEnName', sel.value));
}

function rate(){ return 0.75; }
function speakKO(t){ const u=new SpeechSynthesisUtterance(t); const ko=speechSynthesis.getVoices().find(v=>/ko/i.test(v.lang||"")); if(ko) u.voice=ko; u.lang='ko-KR'; u.rate=rate(); speechSynthesis.speak(u);}
function speakEN(t){ const sel=document.getElementById('voiceEn'); let en=speechSynthesis.getVoices().find(v=>v.name===sel.value) || listEn()[0]; const u=new SpeechSynthesisUtterance(t); if(en) u.voice=en; u.lang=en? en.lang : 'en-US'; u.rate=rate(); if(document.getElementById('mickey').classList.contains('on')) u.pitch=1.6; speechSynthesis.speak(u);}
document.getElementById('mickey').addEventListener('click',e=>e.target.classList.toggle('on'));
document.getElementById('speakKo').addEventListener('click',()=>speakKO(document.getElementById('koText').textContent||""));
document.getElementById('speakEn').addEventListener('click',()=>speakEN(document.getElementById('enText').textContent||""));

async function myMemory(q, from, to){
  const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(q)}&langpair=${from}|${to}`;
  const r = await fetch(url); const j = await r.json(); return j?.responseData?.translatedText || "";
}
async function libre(q, from, to){
  const r = await fetch("https://libretranslate.de/translate", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({q, source:from, target:to}) });
  const j = await r.json(); return j?.translatedText || "";
}
async function translateAll(zh){
  let en="", ko="";
  try{ en = await myMemory(zh,"zh-TW","en"); }catch(e){}
  try{ ko = await myMemory(zh,"zh-TW","ko"); }catch(e){}
  if(!en){ try{ en = await libre(zh,"zh","en"); }catch(e){} }
  if(!ko){ try{ ko = await libre(zh,"zh","ko"); }catch(e){} }
  return {en, ko};
}

function getFavs(){ try{ return JSON.parse(localStorage.getItem('favorites')||'[]'); }catch(e){ return []; } }
function setFavs(a){ localStorage.setItem('favorites', JSON.stringify(a)); }
function getHist(){ try{ return JSON.parse(localStorage.getItem('history')||'[]'); }catch(e){ return []; } }
function setHist(a){ localStorage.setItem('history', JSON.stringify(a.slice(0,10))); }

const FOLDERS=["旅行","購物","問路","其他"];
function chooseFolder(){
  return new Promise((resolve)=>{
    const modal=document.createElement('div'); modal.className='modal'; modal.style.display='flex';
    modal.innerHTML=`<div class='panel'>
      <div class='row'><div style='font-weight:700'>收藏到資料夾</div><button class='back' id='cancel'>取消</button></div>
      <div style='display:flex;gap:8px;flex-wrap:wrap;margin-top:10px'>` + 
        FOLDERS.map(f=>`<button class='control folder' data-f='${f}'>${f}</button>`).join('') + 
      `</div></div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click',(e)=>{ if(e.target.id==='cancel'){ document.body.removeChild(modal); resolve(null); }
      const f=e.target.getAttribute('data-f'); if(f){ document.body.removeChild(modal); resolve(f); }
    });
  });
}

const btn=document.getElementById('btnTrans');
const cn=document.getElementById('cn');
const res=document.getElementById('res');
const zhText=document.getElementById('zhText');
const enText=document.getElementById('enText');
const koText=document.getElementById('koText');
const star=document.getElementById('star');

btn.addEventListener('click', async ()=>{
  const text=(cn.value||"").trim(); if(!text) return;
  res.style.display='block'; zhText.textContent=text; enText.textContent="翻譯中…"; koText.textContent="번역 중…";
  try{ const out=await translateAll(text); enText.textContent=out.en||"(英文失敗)"; koText.textContent=out.ko||"(韓文失敗)"; }
  catch(e){ enText.textContent="(英文錯誤)"; koText.textContent="(韓文錯誤)"; }
  const hist=getHist(); hist.unshift({ zh: zhText.textContent, en: enText.textContent, ko: koText.textContent, ts: Date.now() }); setHist(hist);
});

star.addEventListener('click', async ()=>{
  const folder=await chooseFolder(); if(!folder) return;
  const list=getFavs(); list.unshift({ zh: zhText.textContent, en: enText.textContent, ko: koText.textContent, folder, ts: Date.now() }); setFavs(list);
  star.textContent="★";
});

window.speechSynthesis.onvoiceschanged = ()=>populate();
populate();
</script>
</body>
</html>
