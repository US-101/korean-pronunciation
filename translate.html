<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>實時翻譯</title><link rel="manifest" href="manifest.json"><link rel="stylesheet" href="styles.css">
<link rel="apple-touch-icon" href="icons/icon-512.png"><script>if('serviceWorker' in navigator){addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));}</script></head><body>
<header class="appbar"><div class="bar"><h1 class="title">實 時 翻 譯</h1></div></header>
<div class="appbar"><div class="row" style="gap:12px;justify-content:center">
  <select id="voiceEn" class="pill" style="appearance:none;padding-right:28px"><option>Daniel</option><option selected>Moira</option><option>Samantha</option><option>Tessa</option></select>
  <span id="mickey" class="pill"><img src="icons/micky.svg" width="20" height="20" alt=""></span>
  <span class="pill amber">x0.75</span>
</div></div>
<main class="wrap">
  <div class="legend">輸 入 中 文</div>
  <textarea id="in" placeholder="請輸入要翻譯的句子…"></textarea>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button class="pill teal" id="btnGo">翻 譯</button>
    <button class="pill" id="btnRe">再 翻 譯</button>
  </div>
  <div class="result list" id="result"></div>
</main>
<nav class="tabbar"><div class="in"><a class='' href='index.html'><span class='ico'><img src='icons/p1.svg' alt=''></span>發音練習</a><a class='' href='travel.html'><span class='ico'><img src='icons/p2.svg' alt=''></span>旅行會話</a><a class='active' href='translate.html'><span class='ico'><img src='icons/p3.svg' alt=''></span>實時翻譯</a><a class='' href='history.html'><span class='ico'><img src='icons/p4.svg' alt=''></span>歷史紀錄</a></div></nav>
<script>
const EN=["Daniel","Moira","Samantha","Tessa"]; function loadEn(){ const all=speechSynthesis.getVoices(); const sel=document.getElementById('voiceEn'); const picked=EN.map(n=>all.find(v=>v.name===n)).filter(Boolean); if(picked.length){ sel.innerHTML=picked.map(v=>`<option>${v.name}</option>`).join(""); const saved=localStorage.getItem('voiceEnName'); if(saved&&picked.some(v=>v.name===saved)) sel.value=saved; sel.addEventListener('change',()=>localStorage.setItem('voiceEnName', sel.value)); } } window.speechSynthesis.onvoiceschanged=loadEn;
document.getElementById('mickey').addEventListener('click',e=>e.currentTarget.classList.toggle('on'));
function speakKO(t){ const u=new SpeechSynthesisUtterance(t);u.lang='ko-KR';u.rate=0.75; const v=speechSynthesis.getVoices().find(v=>/ko/i.test(v.lang||'')); if(v) u.voice=v; speechSynthesis.speak(u);}
function speakEN(t){ const sel=document.getElementById('voiceEn'); const v=speechSynthesis.getVoices().find(v=>v.name===sel.value)||speechSynthesis.getVoices().find(v=>/en/i.test(v.lang||'')); const u=new SpeechSynthesisUtterance(t); if(v) u.voice=v; u.rate=0.75; if(document.getElementById('mickey').classList.contains('on')) u.pitch=1.6; speechSynthesis.speak(u);}
async function tMM(q,from,to){ const r=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(q)}&langpair=${from}|${to}`); const j=await r.json(); return j?.responseData?.translatedText || ""; }
async function tLibre(q,from,to){ const r=await fetch("https://libretranslate.de/translate", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q,source:from,target:to})}); const j=await r.json(); return j?.translatedText || ""; }
async function doTranslate(text){ let ko="",en=""; try{en=await tMM(text,"zh-TW","en");}catch(e){} try{ko=await tMM(text,"zh-TW","ko");}catch(e){} if(!en){try{en=await tLibre(text,"zh","en");}catch(e){}} if(!ko){try{ko=await tLibre(text,"zh","ko");}catch(e){}} return {ko,en}; }
function hist(){ try{ return JSON.parse(localStorage.getItem('history')||'[]'); }catch(e){ return []; } }
function saveHist(entry){ const h=hist(); h.unshift(Object.assign({ts:Date.now()}, entry)); localStorage.setItem('history', JSON.stringify(h.slice(0,10))); }
function renderCard(text,out,starId){ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<div class='ko'>${out.ko||"(韓文失敗)"}</div><div class='en'>${out.en||"(英文失敗)"}</div><div class='zh'>${text}</div><div class='badges'><span class='badge' data-ko='${out.ko}'>韓</span><span class='badge' data-en='${out.en}'>英</span><span class='star' id='${starId}' title='收藏'>☆</span></div>`; const result=document.getElementById('result'); result.innerHTML=''; result.appendChild(card); }
async function translateAndMaybeSave(save){ const text=(document.getElementById('in').value||'').trim(); if(!text) return; const out=await doTranslate(text); renderCard(text,out,'fstar'); if(save) saveHist({ko:out.ko,en:out.en,zh:text}); }
document.getElementById('btnGo').addEventListener('click',()=>translateAndMaybeSave(true));
document.getElementById('btnRe').addEventListener('click',()=>translateAndMaybeSave(false));
document.addEventListener('click', (e)=>{ if(e.target.matches('[data-ko]')) return speakKO(e.target.getAttribute('data-ko')); if(e.target.matches('[data-en]')) return speakEN(e.target.getAttribute('data-en')); if(e.target.id==='fstar'){ const pick=prompt("收藏到哪個資料夾？（旅行/購物/問路/其他）","旅行"); if(!pick) return; const c=e.target.closest('.card'); const payload={ko:c.querySelector('.ko').textContent,en:c.querySelector('.en').textContent,zh:c.querySelector('.zh').textContent,folder:pick,ts:Date.now()}; const favs=JSON.parse(localStorage.getItem('favorites')||'[]'); favs.unshift(payload); localStorage.setItem('favorites', JSON.stringify(favs)); e.target.classList.add('on'); e.target.textContent='★'; } });
</script></body></html>
